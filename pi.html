<!DOCTYPE html>
    <html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –û–û–û "–í–µ–∫—Ç–æ—Ä"</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="logo_vector.svg">
    <link rel="alternate icon" href="logo_vector.svg">
    
    <!-- Tailwind CSS (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) -->
    <link rel="stylesheet" href="css/tailwind.generated.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dark-theme.css" media="(prefers-color-scheme: dark)">
    
    <!-- React –∏ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Ant Design -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.13.2/dist/reset.css">
    <script src="https://cdn.jsdelivr.net/npm/antd@5.13.2/dist/antd.min.js"></script>
    
    <!-- Babel –¥–ª—è —Ç—Ä–∞–Ω—Å–ø–∏–ª—è—Ü–∏–∏ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Data Files -->
    <script src="js/translations.js"></script>
    <script src="js/incoterms.js"></script>
    <script src="js/organizations.js"></script>
    <script src="js/cities.js"></script>
</head>
<body>
    <!-- Skip Link –¥–ª—è keyboard navigation (A11Y) -->
    <a href="#printable-content" class="skip-link" style="position: absolute; top: -40px; left: 0; background: #2563eb; color: white; padding: 8px 16px; text-decoration: none; border-radius: 0 0 8px 0; z-index: 9999; transition: top 0.2s;">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
    </a>
    
    <div id="root"></div>

    <!-- Main Application -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const AntdButton = window.antd?.Button;
        const Button = AntdButton || (({ children, className = '', type = 'default', href, ...props }) => {
          const base =
            type === 'primary'
              ? 'bg-blue-600 hover:bg-blue-700 text-white'
              : type === 'link'
                ? 'text-blue-600 hover:text-blue-800 underline'
                : 'bg-gray-200 hover:bg-gray-300 text-gray-800';
          const common = {
            className: `px-6 py-2 rounded font-medium transition ${base} ${className}`,
            ...props
          };
          if (href) {
            return React.createElement('a', { ...common, href }, children);
          }
          return React.createElement('button', common, children);
        });

        // Helper Functions (—Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫)
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', 
                         '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
          return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()} –≥.`;
        };

        const formatNumber = (num) => {
          return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL API
        const getApiUrl = (endpoint) => {
          const currentPath = window.location.pathname;
          const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
          return basePath + '/api/' + endpoint;
        };

        // Reusable Components
        const warrantyTemplates = [
          {
            label: '12 –º–µ—Å. –æ—Ç –ø—É—Å–∫–∞ / 18 –º–µ—Å. –æ—Ç –æ—Ç–≥—Ä—É–∑–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)',
            value: '12 –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –ø—É—Å–∫–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é –∏–ª–∏ 18 –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏'
          },
          {
            label: '18 –º–µ—Å. –æ—Ç –ø—É—Å–∫–∞ / 24 –º–µ—Å. –æ—Ç –æ—Ç–≥—Ä—É–∑–∫–∏',
            value: '18 –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –ø—É—Å–∫–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é –∏–ª–∏ 24 –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏'
          },
          {
            label: '12 –º–µ—Å—è—Ü–µ–≤ –æ—Ç –¥–∞—Ç—ã –ø–æ—Å—Ç–∞–≤–∫–∏',
            value: '12 –º–µ—Å—è—Ü–µ–≤ —Å –¥–∞—Ç—ã –ø–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏'
          }
        ];

        const paymentTemplates = [
          { label: '30% –∞–≤–∞–Ω—Å / 70% –¥–æ –æ—Ç–≥—Ä—É–∑–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)', value: '30% –∞–≤–∞–Ω—Å, 70% –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ' },
          { label: '50% –∞–≤–∞–Ω—Å / 50% –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π', value: '50% –∞–≤–∞–Ω—Å, 50% –ø–µ—Ä–µ–¥ –æ—Ç–≥—Ä—É–∑–∫–æ–π' },
          { label: '100% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞', value: '100% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –ø–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º—É —Å—á—ë—Ç—É' },
          { label: '70% –∞–≤–∞–Ω—Å / 30% –ø–æ—Å–ª–µ –º–æ–Ω—Ç–∞–∂–∞', value: '70% –∞–≤–∞–Ω—Å, 30% –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ' },
          { label: '100% –ø–æ—Å–ª–µ –æ—Ç–≥—Ä—É–∑–∫–∏, –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π', value: '100% –ø–æ—Å–ª–µ –æ—Ç–≥—Ä—É–∑–∫–∏, –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π' }
        ];

        const deliveryTimeTemplates = [
          { label: '60‚Äì75 –¥–Ω–µ–π –ø–æ—Å–ª–µ –∞–≤–∞–Ω—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)', value: '60-75 –¥–Ω–µ–π –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∞–≤–∞–Ω—Å–∞' },
          { label: '45‚Äì60 –¥–Ω–µ–π –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã', value: '45-60 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã' },
          { label: '–í –Ω–∞–ª–∏—á–∏–∏, 5‚Äì7 –¥–Ω–µ–π', value: '–ü–æ—Å—Ç–∞–≤–∫–∞ —Å–æ —Å–∫–ª–∞–¥–∞, —Å—Ä–æ–∫ 5-7 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π' },
          { label: '90‚Äì120 –¥–Ω–µ–π', value: '90-120 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã' },
          { label: '150‚Äì180 –¥–Ω–µ–π', value: '150-180 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã' }
        ];

        const contactTemplates = [
          { id: 'petrov', person: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', position: '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–∏—Ä–µ–∫—Ç–æ—Ä' },
          { id: 'ivanova', person: '–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞', position: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º' },
          { id: 'sidorov', person: '–ê–ª–µ–∫—Å–µ–π –°–∏–¥–æ—Ä–æ–≤', position: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–æ–≤' },
          { id: 'smirnova', person: '–ú–∞—Ä–∏—è –°–º–∏—Ä–Ω–æ–≤–∞', position: '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä' }
        ];

        const CityAutocomplete = React.memo(({ value, onChange, onCitySelect, onBlur, results, showDropdown, onClose, disabled }) => {
          const wrapperRef = useRef(null);
          const inputRef = useRef(null);
          
          useEffect(() => {
            const handleClickOutside = (event) => {
              if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                onClose();
              }
            };
            
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, [onClose]);
          
          return (
            <div ref={wrapperRef} className="relative">
              <input
                ref={inputRef}
                type="text"
                value={value || ''}
                onChange={onChange}
                onBlur={onBlur}
                disabled={disabled}
                placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥..."
                autoComplete="off"
                className={`w-full px-3 py-2 border-2 rounded-md ${
                  disabled 
                    ? 'border-gray-200 bg-gray-100 cursor-not-allowed' 
                    : 'border-blue-300 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200'
                } transition-all`}
              />
              
              {showDropdown && results.length > 0 && (
                <div className="absolute z-50 w-full mt-1 bg-white border-2 border-blue-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                  {results.map((city, index) => (
                    <div
                      key={`${city.name}-${index}`}
                      onClick={() => onCitySelect(city)}
                      onMouseDown={(e) => e.preventDefault()}
                      className="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                    >
                      <div className="font-medium text-gray-900 text-sm">
                        {city.fullAddress || city.name}
                      </div>
                      {city.postal_code && (
                        <div className="text-xs text-blue-600 mt-0.5">üìÆ {city.postal_code}</div>
                      )}
                      {!city.fullAddress && city.region && (
                        <div className="text-xs text-gray-500">{city.region}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        });

        const AddressAutocomplete = React.memo(({ value, onChange, onAddressSelect, results, showDropdown, onClose, disabled }) => {
          const wrapperRef = useRef(null);
          const inputRef = useRef(null);
          
          useEffect(() => {
            const handleClickOutside = (event) => {
              if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                onClose();
              }
            };
            
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, [onClose]);
          
          return (
            <div ref={wrapperRef} className="relative">
              <textarea
                ref={inputRef}
                value={value || ''}
                onChange={onChange}
                disabled={disabled}
                placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å..."
                autoComplete="off"
                rows={2}
                className={`w-full px-3 py-2 border rounded-md ${
                  disabled 
                    ? 'border-gray-200 bg-gray-100 cursor-not-allowed' 
                    : 'border-gray-300 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500'
                } transition-all resize-none`}
              />
              
              {showDropdown && results.length > 0 && (
                <div className="absolute z-50 w-full mt-1 bg-white border-2 border-blue-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                  {results.map((addr, index) => (
                    <div
                      key={`${addr.fias_id}-${index}`}
                      onClick={() => onAddressSelect(addr)}
                      onMouseDown={(e) => e.preventDefault()}
                      className="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                    >
                      <div className="font-medium text-gray-900 text-sm">{addr.value}</div>
                      {addr.postal_code && (
                        <div className="text-xs text-blue-600 mt-0.5">üìÆ {addr.postal_code}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        });

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        const DeleteConfirmModal = ({ isOpen, onClose, onConfirm, itemName }) => {
          useEffect(() => {
            if (isOpen) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = '';
            }
            return () => {
              document.body.style.overflow = '';
            };
          }, [isOpen]);
          
          if (!isOpen) return null;
          
          return ReactDOM.createPortal(
            <div 
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(0, 0, 0, 0.5)',
                zIndex: 9999,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '1rem'
              }}
              onClick={onClose}
            >
              <div 
                className="bg-white rounded-lg shadow-xl overflow-hidden"
                style={{
                  maxWidth: '25rem',
                  width: '100%',
                  maxHeight: '90vh',
                  overflowY: 'auto'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */}
                <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-6 border-b">
                  <h2 className="text-xl font-bold text-blue-900">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
                </div>
                
                {/* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ */}
                <div className="p-6">
                  <p className="text-gray-700 mb-2">
                    –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é:
                  </p>
                  <p className="font-semibold text-gray-900 mb-6 bg-gray-50 p-3 rounded border border-gray-200">
                    "{itemName}"
                  </p>
                  
                  {/* –ö–Ω–æ–ø–∫–∏ */}
                  <div className="flex gap-3 justify-end">
                    <button
                      type="button"
                      onClick={onClose}
                      style={{
                        backgroundColor: '#e5e7eb',
                        color: '#1f2937',
                        padding: '0.5rem 1.5rem',
                        borderRadius: '0.375rem',
                        fontWeight: 500,
                        border: 'none',
                        cursor: 'pointer',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseOver={(e) => e.target.style.backgroundColor = '#d1d5db'}
                      onMouseOut={(e) => e.target.style.backgroundColor = '#e5e7eb'}
                    >
                      –û—Ç–º–µ–Ω–∞
                    </button>
                    <button
                      type="button"
                      onClick={onConfirm}
                      style={{
                        backgroundColor: '#dc2626',
                        color: '#ffffff',
                        padding: '0.5rem 1.5rem',
                        borderRadius: '0.375rem',
                        fontWeight: 500,
                        border: 'none',
                        cursor: 'pointer',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseOver={(e) => e.target.style.backgroundColor = '#b91c1c'}
                      onMouseOut={(e) => e.target.style.backgroundColor = '#dc2626'}
                    >
                      –£–¥–∞–ª–∏—Ç—å
                    </button>
                  </div>
                </div>
              </div>
            </div>,
            document.body
          );
        };

        const AutoResizeTextarea = ({ field, rows = 2, viewMode, formData, handleChange }) => {
          const isReadOnly = viewMode === 'print';
          const textareaRef = useRef(null);
          
          const adjustHeight = () => {
            if (textareaRef.current) {
              textareaRef.current.style.height = 'auto';
              const scrollHeight = textareaRef.current.scrollHeight;
              if (!isReadOnly) {
                const minHeight = rows * 24 + 16;
                const maxHeight = 400;
                const newHeight = Math.max(minHeight, Math.min(scrollHeight + 8, maxHeight));
                textareaRef.current.style.height = newHeight + 'px';
                textareaRef.current.style.overflowY = scrollHeight + 8 > maxHeight ? 'auto' : 'hidden';
              } else {
                textareaRef.current.style.height = scrollHeight + 8 + 'px';
                textareaRef.current.style.overflowY = 'hidden';
              }
            }
          };
          
          useEffect(() => {
            adjustHeight();
            const timer = setTimeout(adjustHeight, 10);
            return () => clearTimeout(timer);
          }, [formData[field], isReadOnly]);
          
          const handleChangeWithResize = (e) => {
            handleChange(e, field);
            setTimeout(adjustHeight, 0);
          };
          
          const handleFocus = () => {
            setTimeout(() => {
              if (textareaRef.current) {
                adjustHeight();
              }
            }, 10);
          };
          
          const handleInput = (e) => {
            handleChange(e, field);
            adjustHeight();
            setTimeout(() => {
              if (textareaRef.current) {
                const textarea = textareaRef.current;
                const cursorPosition = textarea.selectionStart;
                const textBeforeCursor = textarea.value.substring(0, cursorPosition);
                
                const tempDiv = document.createElement('div');
                const computedStyle = window.getComputedStyle(textarea);
                tempDiv.style.position = 'absolute';
                tempDiv.style.visibility = 'hidden';
                tempDiv.style.whiteSpace = 'pre-wrap';
                tempDiv.style.wordWrap = 'break-word';
                tempDiv.style.width = computedStyle.width;
                tempDiv.style.font = computedStyle.font;
                tempDiv.style.padding = computedStyle.padding;
                tempDiv.style.border = computedStyle.border;
                tempDiv.style.boxSizing = computedStyle.boxSizing;
                tempDiv.textContent = textBeforeCursor;
                
                document.body.appendChild(tempDiv);
                const cursorTop = tempDiv.offsetHeight;
                document.body.removeChild(tempDiv);
                
                const scrollTop = textarea.scrollTop;
                const clientHeight = textarea.clientHeight;
                const lineHeight = parseInt(computedStyle.lineHeight) || 20;
                
                if (cursorTop < scrollTop + lineHeight) {
                  textarea.scrollTop = Math.max(0, cursorTop - lineHeight * 2);
                } else if (cursorTop > scrollTop + clientHeight - lineHeight * 2) {
                  textarea.scrollTop = cursorTop - clientHeight + lineHeight * 2;
                }
              }
            }, 0);
          };
          
          return (
            <textarea
              ref={textareaRef}
              value={formData[field]}
              onChange={!isReadOnly ? handleInput : handleChangeWithResize}
              onFocus={handleFocus}
              readOnly={isReadOnly}
              rows={isReadOnly ? 1 : rows}
              className={`w-full px-3 py-2 border rounded-md resize-none ${
                isReadOnly ? 'border-none bg-transparent' : 'border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
              }`}
              style={{
                minHeight: isReadOnly ? 'auto' : `${rows * 24 + 16}px`,
                maxHeight: isReadOnly ? 'none' : '400px',
                overflowY: isReadOnly ? 'hidden' : 'auto'
              }}
            />
          );
        };

        // Main App Component  
        const App = () => {
          const language = 'ru'; // –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
          const [organization, setOrganization] = useState(null);
          const [viewMode, setViewMode] = useState('edit');
          const [saveStatus, setSaveStatus] = useState('');
          const [loadedFilename, setLoadedFilename] = useState(null);
          const [innLoading, setInnLoading] = useState(false);
          const [citySearchResults, setCitySearchResults] = useState([]);
          const [showCityDropdown, setShowCityDropdown] = useState(false);
          const [addressSearchResults, setAddressSearchResults] = useState([]);
          const [showAddressDropdown, setShowAddressDropdown] = useState(false);
          const [deliveryPlaceInput, setDeliveryPlaceInput] = useState(''); // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
          const [deleteModalIndex, setDeleteModalIndex] = useState(null); // –ò–Ω–¥–µ–∫—Å –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (null = –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫—Ä—ã—Ç–æ)
          const [templateSelection, setTemplateSelection] = useState({
            paymentTerms: '',
            warranty: '',
            deliveryTime: '',
            contact: ''
          });
          
          // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
          const [backupFormData, setBackupFormData] = useState(null);
          const [backupDeliveryPlaceInput, setBackupDeliveryPlaceInput] = useState(null);
          
          const [formData, setFormData] = useState({
            number: '',
            date: new Date().toISOString().split('T')[0],
            validUntil: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
            currency: 'RUB',
            recipient: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏',
            recipientAddress: '–ê–¥—Ä–µ—Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏',
            recipientINN: '',
            items: [{
              type: '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞',
              name: '–ú–æ–¥–µ–ª—å',
              hsCode: '8483.40',
              countryOfOrigin: '–†–æ—Å—Å–∏—è',
              unit: '—à—Ç.',
              quantity: 1,
              price: 0,
              leadTime: '60-75 –¥–Ω–µ–π'
            }],
            incoterm: '–°–ê–ú–û–í–´–í–û–ó',
            deliveryPlace: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –†–æ—Å—Å–∏—è',
            deliveryTime: '60-75 –¥–Ω–µ–π –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∞–≤–∞–Ω—Å–∞',
            paymentTerms: '30% –∞–≤–∞–Ω—Å, 70% –¥–æ –æ—Ç–≥—Ä—É–∑–∫–∏',
            warranty: '12 –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –ø—É—Å–∫–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é –∏–ª–∏ 18 –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏',
            remarks: '–í—Å–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ–¥–ª–µ–∂–∞—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–º—É —É—Ç–æ—á–Ω–µ–Ω–∏—é',
            contactPerson: '–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞',
            position: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º',
            organizationId: null,
            selectedBankId: null, // ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞
            documentType: 'regular' // –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞: 'regular' –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ö–ü
          });
          
          // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –±—ã–ª –ª–∏ –Ω–æ–º–µ—Ä –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
          const [numberManuallyEdited, setNumberManuallyEdited] = useState(false);

          const t = translations[language];
          
          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è deliveryPlaceInput —Å formData.deliveryPlace –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
          // (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏–∑–≤–Ω–µ, –Ω–µ –æ—Ç –Ω–∞—à–µ–≥–æ onBlur)
          useEffect(() => {
            if (formData.deliveryPlace !== deliveryPlaceInput) {
              setDeliveryPlaceInput(formData.deliveryPlace || '');
            }
          }, [formData.deliveryPlace]); // deliveryPlaceInput –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
          
          // –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≥–æ—Ä–æ–¥–æ–≤ (—á–µ—Ä–µ–∑ DaData)
          const handleCitySelect = useCallback((city) => {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –æ—Ç DaData - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
            const selectedAddress = city.fullAddress || `${city.name}, –†–æ—Å—Å–∏—è`;
            setDeliveryPlaceInput(selectedAddress); // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            setFormData(prev => ({ ...prev, deliveryPlace: selectedAddress }));
            setCitySearchResults([]);
            setShowCityDropdown(false);
          }, []);
          
          const handleCloseCityDropdown = useCallback(() => {
            setShowCityDropdown(false);
          }, []);
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –∞–¥—Ä–µ—Å–æ–≤
          const handleAddressSelect = useCallback((address) => {
            setFormData(prev => ({ ...prev, recipientAddress: address.value }));
            setAddressSearchResults([]);
            setShowAddressDropdown(false);
          }, []);
          
          const handleCloseAddressDropdown = useCallback(() => {
            setShowAddressDropdown(false);
          }, []);
          
          // Debounce –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–¥—Ä–µ—Å–æ–≤
          const addressSearchTimeout = useRef(null);
          
          const handleAddressChange = useCallback((e) => {
            const value = e.target.value;
            const searchQuery = value.trim();
            
            setFormData(prev => ({ ...prev, recipientAddress: value }));
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
            if (addressSearchTimeout.current) {
              clearTimeout(addressSearchTimeout.current);
            }
            
            if (searchQuery.length >= 3) {
              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è debounce (300ms)
              addressSearchTimeout.current = setTimeout(() => {
                // –ó–∞–ø—Ä–æ—Å –∫ DaData API
                fetch(`api/address-suggest.php?query=${encodeURIComponent(searchQuery)}&count=10`)
                  .then(response => response.json())
                  .then(data => {
                    if (data.success && data.suggestions) {
                      setAddressSearchResults(data.suggestions);
                      setShowAddressDropdown(data.suggestions.length > 0);
                    } else {
                      setAddressSearchResults([]);
                      setShowAddressDropdown(false);
                    }
                  })
                  .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∞–¥—Ä–µ—Å–æ–≤:', error);
                    setAddressSearchResults([]);
                    setShowAddressDropdown(false);
                  });
              }, 300);
            } else {
              setAddressSearchResults([]);
              setShowAddressDropdown(false);
            }
          }, []);
          
          // –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å–ª–æ–≤–∏—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
          const isPickupCondition = useMemo(() => {
            return formData.incoterm === '–°–ê–ú–û–í–´–í–û–ó' || 
                   formData.incoterm === '–§–†–ê–ù–ö–û-–°–ö–õ–ê–î –ü–†–û–î–ê–í–¶–ê' || 
                   formData.incoterm === '–î–û –¢–†–ê–ù–°–ü–û–†–¢–ê –ü–û–ö–£–ü–ê–¢–ï–õ–Ø';
          }, [formData.incoterm]);
          
          // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ —á–µ—Ä–µ–∑ DaData
          const citySearchTimeout = useRef(null);
          
          // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è –≥–æ—Ä–æ–¥–∞ (—á–µ—Ä–µ–∑ DaData API)
          const handleDeliveryPlaceChange = useCallback((e) => {
            const value = e.target.value;
            const searchQuery = value.trim();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–µ formData!)
            setDeliveryPlaceInput(value);
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
            if (citySearchTimeout.current) {
              clearTimeout(citySearchTimeout.current);
            }
            
            if (!isPickupCondition && searchQuery.length >= 2) {
              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º debounce (300ms)
              citySearchTimeout.current = setTimeout(() => {
                // –ó–∞–ø—Ä–æ—Å –∫ DaData API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤
                fetch(`api/address-suggest.php?query=${encodeURIComponent(searchQuery)}&count=10`)
                  .then(response => response.json())
                  .then(data => {
                    if (data.success && data.suggestions) {
                      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã DaData –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è CityAutocomplete
                      const cityResults = data.suggestions.map(addr => ({
                        name: addr.city || addr.value.split(',')[0],
                        region: addr.region || '–†–æ—Å—Å–∏—è',
                        fullAddress: addr.value,
                        postal_code: addr.postal_code
                      }));
                      setCitySearchResults(cityResults);
                      setShowCityDropdown(cityResults.length > 0);
                    } else {
                      setCitySearchResults([]);
                      setShowCityDropdown(false);
                    }
                  })
                  .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞:', error);
                    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    const results = searchCities(searchQuery);
                    setCitySearchResults(results);
                    setShowCityDropdown(results.length > 0);
                  });
              }, 300);
            } else {
              setCitySearchResults([]);
              setShowCityDropdown(false);
            }
          }, [isPickupCondition]);
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ formData
          const handleDeliveryPlaceBlur = useCallback(() => {
            if (deliveryPlaceInput !== formData.deliveryPlace) {
              setFormData(prev => ({ ...prev, deliveryPlace: deliveryPlaceInput }));
            }
          }, [deliveryPlaceInput, formData.deliveryPlace]);

          // Effects
          
          // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –û–û–û "–í–µ–∫—Ç–æ—Ä")
          useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const filenameParam = urlParams.get('filename');
            
            const selectedOrg = getDefaultOrganization(); // –í—Å–µ–≥–¥–∞ –û–û–û "–í–µ–∫—Ç–æ—Ä"
            setOrganization(selectedOrg);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º organizationId –≤ formData —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            if (!filenameParam) {
              const currentDate = new Date().toISOString().split('T')[0];
              
              setFormData(prev => ({
                ...prev,
                organizationId: selectedOrg.id,
                selectedBankId: null
              }));
              
              // –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –ö–ü —á–µ—Ä–µ–∑ API
              fetch(`api/get_next_invoice_number.php?orgId=${encodeURIComponent(selectedOrg.id)}&date=${encodeURIComponent(currentDate)}`)
                .then(response => response.json())
                .then(data => {
                  if (data.success && data.number) {
                    setFormData(prev => ({ ...prev, number: data.number }));
                  }
                })
                .catch(error => {
                  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–æ–º–µ—Ä–∞ –ö–ü:', error);
                  // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç DDMMYY-01
                  const dateObj = new Date(currentDate);
                  const day = String(dateObj.getDate()).padStart(2, '0');
                  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                  const year = String(dateObj.getFullYear()).slice(-2);
                  const fallbackNumber = `${day}${month}${year}-01`;
                  setFormData(prev => ({ ...prev, number: fallbackNumber }));
                });
            }
          }, []);
          
          useEffect(() => {
            if (organization) {
              document.title = `${t.title} - ${organization.name}`;
            }
          }, [organization]);

          useEffect(() => {
            if (formData.date) {
              const dateObj = new Date(formData.date);
              dateObj.setDate(dateObj.getDate() + 30);
              const newValidUntil = dateObj.toISOString().split('T')[0];
              
              const currentValidUntil = new Date(formData.validUntil);
              if (!formData.validUntil || currentValidUntil < new Date(formData.date)) {
                setFormData(prev => ({ ...prev, validUntil: newValidUntil }));
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –ö–ü –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
              // 1. –≠—Ç–æ –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π)
              // 2. –ù–æ–º–µ—Ä –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –±—ã–ª –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
              const urlParams = new URLSearchParams(window.location.search);
              const filenameParam = urlParams.get('filename');
              if (!filenameParam && organization && (!formData.number || !numberManuallyEdited)) {
                fetch(`api/get_next_invoice_number.php?orgId=${encodeURIComponent(organization.id)}&date=${encodeURIComponent(formData.date)}`)
                  .then(response => response.json())
                  .then(data => {
                    if (data.success && data.number) {
                      setFormData(prev => ({ ...prev, number: data.number }));
                      setNumberManuallyEdited(false);
                    }
                  })
                  .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–æ–º–µ—Ä–∞ –ö–ü:', error);
                  });
              }
            }
          }, [formData.date, formData.number, organization, numberManuallyEdited]);

          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º —Å—Ä–æ–∫–µ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
          useEffect(() => {
            const additionalText = '*C—Ä–æ–∫ —É–∫–∞–∑–∞–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–∞ –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏';
            const hasMultipleItems = formData.items && formData.items.length > 1;
            const currentRemarks = formData.remarks || '';
            const hasAdditionalText = currentRemarks.includes(additionalText);
            
            if (hasMultipleItems && !hasAdditionalText) {
              // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç, —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥ –Ω–µ–π
              const separator = currentRemarks.trim() ? '\n\n' : '';
              setFormData(prev => ({
                ...prev,
                remarks: prev.remarks + separator + additionalText
              }));
            } else if (!hasMultipleItems && hasAdditionalText) {
              // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏–π —Å—Ç–∞–ª–æ 1 –∏–ª–∏ –º–µ–Ω—å—à–µ
              const lines = currentRemarks.split('\n');
              const filteredLines = lines.filter(line => !line.includes(additionalText));
              setFormData(prev => ({
                ...prev,
                remarks: filteredLines.join('\n').trim()
              }));
            }
          }, [formData.items?.length]);

          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
          const shortenOrganizationName = (fullName) => {
            if (!fullName) return '';
            
            let name = fullName.trim();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –ª–∏ —É–∂–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            const alreadyShortened = /^(–ü–ê–û|–ó–ê–û|–ê–û|–û–û–û|–ò–ü|–û–î–û|–ü–¢|–¢–ù–í)\s+/i.test(name);
            if (alreadyShortened) {
              return name; // –ï—Å–ª–∏ —É–∂–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            }
            
            // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∑–∞–º–µ–Ω—ã (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω - —Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã)
            const replacements = [
              // –ü—É–±–ª–∏—á–Ω–æ–µ –∞–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ
              { pattern: /^–ü–£–ë–õ–ò–ß–ù–û–ï\s+–ê–ö–¶–ò–û–ù–ï–†–ù–û–ï\s+–û–ë–©–ï–°–¢–í–û\s+/i, replacement: '–ü–ê–û ' },
              
              // –ó–∞–∫—Ä—ã—Ç–æ–µ –∞–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ
              { pattern: /^–ó–ê–ö–†–´–¢–û–ï\s+–ê–ö–¶–ò–û–ù–ï–†–ù–û–ï\s+–û–ë–©–ï–°–¢–í–û\s+/i, replacement: '–ó–ê–û ' },
              
              // –û–±—â–µ—Å—Ç–≤–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é
              { pattern: /^–û–ë–©–ï–°–¢–í–û\s+–°\s+–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ô\s+–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨–Æ\s+/i, replacement: '–û–î–û ' },
              
              // –û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é
              { pattern: /^–û–ë–©–ï–°–¢–í–û\s+–°\s+–û–ì–†–ê–ù–ò–ß–ï–ù–ù–û–ô\s+–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨–Æ\s+/i, replacement: '–û–û–û ' },
              
              // –ê–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –ü–ê–û –∏ –ó–ê–û)
              { pattern: /^–ê–ö–¶–ò–û–ù–ï–†–ù–û–ï\s+–û–ë–©–ï–°–¢–í–û\s+/i, replacement: '–ê–û ' },
              
              // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å
              { pattern: /^–ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô\s+–ü–†–ï–î–ü–†–ò–ù–ò–ú–ê–¢–ï–õ–¨\s+/i, replacement: '–ò–ü ' },
              
              // –ü–æ–ª–Ω–æ–µ —Ç–æ–≤–∞—Ä–∏—â–µ—Å—Ç–≤–æ
              { pattern: /^–ü–û–õ–ù–û–ï\s+–¢–û–í–ê–†–ò–©–ï–°–¢–í–û\s+/i, replacement: '–ü–¢ ' },
              
              // –¢–æ–≤–∞—Ä–∏—â–µ—Å—Ç–≤–æ –Ω–∞ –≤–µ—Ä–µ
              { pattern: /^–¢–û–í–ê–†–ò–©–ï–°–¢–í–û\s+–ù–ê\s+–í–ï–†–ï\s+/i, replacement: '–¢–ù–í ' },
            ];
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–º–µ–Ω—ã
            for (const { pattern, replacement } of replacements) {
              if (pattern.test(name)) {
                name = name.replace(pattern, replacement);
                break; // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –∑–∞–º–µ–Ω—É
              }
            }
            
            return name;
          };

          // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –ò–ù–ù
          useEffect(() => {
            const inn = formData.recipientINN;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ò–ù–ù –≤–∞–ª–∏–¥–Ω—ã–π (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)
            if (inn && (inn.length === 10 || inn.length === 12)) {
              // Debounce: –∂–¥–µ–º 500ms –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
              const timeoutId = setTimeout(() => {
                setInnLoading(true);
                
                // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                fetch(`https://tkp.1000a.ru/api/company-info.php?inn=${encodeURIComponent(inn)}`)
                  .then(response => response.json())
                  .then(data => {
                    setInnLoading(false);
                    
                    if (data && !data.error && data.found) {
                      // –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                      const isDefaultRecipient = !formData.recipient || 
                        formData.recipient === '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏' || 
                        formData.recipient.trim() === '';
                      
                      if (isDefaultRecipient) {
                        let organizationName = '';
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ API –∫–æ—Ä–æ—Ç–∫–∞—è —Ñ–æ—Ä–º–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
                        if (data.shortName || data.nameShort || data.name_short) {
                          organizationName = data.shortName || data.nameShort || data.name_short;
                        } else if (data.name) {
                          // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
                          organizationName = shortenOrganizationName(data.name);
                        }
                        
                        if (organizationName) {
                          setFormData(prev => ({ ...prev, recipient: organizationName }));
                        }
                      }
                      
                      // –ó–∞–ø–æ–ª–Ω—è–µ–º –∞–¥—Ä–µ—Å, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                      const isDefaultAddress = !formData.recipientAddress || 
                        formData.recipientAddress === '–ê–¥—Ä–µ—Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏' || 
                        formData.recipientAddress.trim() === '';
                      
                      if (isDefaultAddress && data.address) {
                        setFormData(prev => ({ ...prev, recipientAddress: data.address }));
                      }
                    }
                  })
                  .catch(error => {
                    setInnLoading(false);
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –ò–ù–ù:', error);
                  });
              }, 500);
              
              return () => clearTimeout(timeoutId);
            } else {
              setInnLoading(false);
            }
          }, [formData.recipientINN]);

          useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('filename');
            
            if (filename) {
              fetch(`api/load.php?filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(result => {
                  if (result.success && result.data) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    let loadedOrg = null;
                    if (result.data.organizationId && organizations[result.data.organizationId]) {
                      loadedOrg = organizations[result.data.organizationId];
                    } else {
                      // –ï—Å–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
                      loadedOrg = getDefaultOrganization();
                    }
                    setOrganization(loadedOrg);
                    
                    // –ï—Å–ª–∏ –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç selectedBankId, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –±–∞–Ω–∫
                    const loadedData = { ...result.data };
                    if (!loadedData.selectedBankId && loadedOrg && loadedOrg.bankAccounts && loadedOrg.bankAccounts.length > 0) {
                      loadedData.selectedBankId = loadedOrg.bankAccounts[0].id;
                    }
                    
                    setFormData(loadedData);
                    setLoadedFilename(filename);
                    setNumberManuallyEdited(true); // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å—á–∏—Ç–∞–µ–º –Ω–æ–º–µ—Ä –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
                    setViewMode('print');
                  }
                })
                .catch(error => console.error('Error loading:', error));
            }
          }, []);

          // –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù
          const validateINN = (inn) => {
            if (!inn) return { valid: true, message: '', type: '' };
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
            const cleanINN = inn.replace(/\D/g, '');
            
            // –ò–ù–ù –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 10 —Ü–∏—Ñ—Ä (–¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π) –∏–ª–∏ 12 —Ü–∏—Ñ—Ä (–¥–ª—è –ò–ü)
            if (cleanINN.length === 10) {
              return { valid: true, message: '', type: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è' };
            } else if (cleanINN.length === 12) {
              return { valid: true, message: '', type: '–ò–ü' };
            } else if (cleanINN.length > 0 && cleanINN.length < 10) {
              return { valid: false, message: '–ò–ù–ù –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 —Ü–∏—Ñ—Ä (–¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π) –∏–ª–∏ 12 —Ü–∏—Ñ—Ä (–¥–ª—è –ò–ü)', type: '' };
            } else if (cleanINN.length > 12) {
              return { valid: false, message: '–ò–ù–ù –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–æ–ª–µ–µ 12 —Ü–∏—Ñ—Ä', type: '' };
            }
            
            return { valid: true, message: '', type: '' };
          };

          // –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ª–æ–≤–∏–π –æ–ø–ª–∞—Ç—ã - —Å—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–≤–Ω–∞ 100%
          const validatePaymentTerms = (paymentTerms) => {
            if (!paymentTerms) return { valid: true, message: '', total: 0 };
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç—ã: 30%, 30 %, 30 –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∏ —Ç.–¥.)
            const percentPattern = /(\d+(?:[.,]\d+)?)\s*%/g;
            const matches = [...paymentTerms.matchAll(percentPattern)];
            
            if (matches.length === 0) {
              // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤, –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
              return { valid: true, message: '', total: 0 };
            }
            
            // –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            let total = 0;
            const percentages = [];
            
            matches.forEach(match => {
              const percent = parseFloat(match[1].replace(',', '.'));
              if (!isNaN(percent)) {
                total += percent;
                percentages.push(percent);
              }
            });
            
            // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            total = Math.round(total * 100) / 100;
            
            if (total < 100) {
              return { 
                valid: false, 
                message: `–°—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${total}%. –û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–≤–Ω–∞ 100%`, 
                total: total,
                percentages: percentages
              };
            } else if (total > 100) {
              return { 
                valid: false, 
                message: `–°—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${total}%. –û–±—â–∞—è —Å—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%`, 
                total: total,
                percentages: percentages
              };
            }
            
            return { valid: true, message: '', total: total, percentages: percentages };
          };

          // Handlers
          const handleChange = (e, field) => {
            const value = e.target.value;
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞
            if (field === 'number') {
              setNumberManuallyEdited(true);
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù
            if (field === 'recipientINN') {
              // –†–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä
              const cleanValue = value.replace(/\D/g, '');
              
              // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤
              const limitedValue = cleanValue.slice(0, 12);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –∏–ª–∏ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –≤–≤–æ–¥–µ
              if (limitedValue.length === 10 || limitedValue.length === 12) {
                const validation = validateINN(limitedValue);
                if (!validation.valid) {
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
                  console.warn(validation.message);
                }
              }
              
              setFormData(prev => ({ ...prev, [field]: limitedValue }));
              return;
            }
            
            if (field === 'validUntil' && formData.date) {
              const validUntilDate = new Date(value);
              const dateDate = new Date(formData.date);
              
              if (validUntilDate < dateDate) {
                alert(t.validUntil + ' cannot be earlier than ' + t.date);
                return;
              }
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ª–æ–≤–∏–π –æ–ø–ª–∞—Ç—ã
            if (field === 'paymentTerms') {
              const validation = validatePaymentTerms(value);
              if (!validation.valid) {
                alert(validation.message);
                // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
              }
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è —É—Å–ª–æ–≤–∏–π —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
            if (field === 'incoterm') {
              const isPickupCondition = value === '–°–ê–ú–û–í–´–í–û–ó' || value === '–§–†–ê–ù–ö–û-–°–ö–õ–ê–î –ü–†–û–î–ê–í–¶–ê' || value === '–î–û –¢–†–ê–ù–°–ü–û–†–¢–ê –ü–û–ö–£–ü–ê–¢–ï–õ–Ø';
              const wasPickupCondition = formData.incoterm === '–°–ê–ú–û–í–´–í–û–ó' || formData.incoterm === '–§–†–ê–ù–ö–û-–°–ö–õ–ê–î –ü–†–û–î–ê–í–¶–ê' || formData.incoterm === '–î–û –¢–†–ê–ù–°–ü–û–†–¢–ê –ü–û–ö–£–ü–ê–¢–ï–õ–Ø';
              
              if (isPickupCondition) {
                // –î–ª—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Å—Ç–æ –∫–∞–∫ —Å–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞ (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)
                setFormData(prev => ({ 
                  ...prev, 
                  [field]: value,
                  deliveryPlace: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –†–æ—Å—Å–∏—è'
                }));
              } else if (wasPickupCondition) {
                // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º —Å —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å–ª–æ–≤–∏–µ - –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
                setFormData(prev => ({ 
                  ...prev, 
                  [field]: value,
                  deliveryPlace: ''
                }));
              } else {
                // –ü—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —É—Å–ª–æ–≤–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ
                setFormData(prev => ({ 
                  ...prev, 
                  [field]: value
                }));
              }
              return;
            }
            
            setFormData(prev => ({ ...prev, [field]: value }));
          };

          const handleItemChange = (index, field, value) => {
            const updatedItems = [...formData.items];
            updatedItems[index] = { ...updatedItems[index], [field]: value };
            setFormData(prev => ({ ...prev, items: updatedItems }));
          };

          const addItem = () => {
            setFormData(prev => ({
              ...prev,
              items: [...prev.items, { 
                type: '', name: '', hsCode: '', countryOfOrigin: '–†–æ—Å—Å–∏—è', 
                unit: '—à—Ç.', quantity: 1, price: 0, leadTime: '' 
              }]
            }));
          };

          const removeItem = (index) => {
            if (formData.items.length > 1) {
              setDeleteModalIndex(index);
            }
          };

          const handleDeleteConfirm = () => {
            if (deleteModalIndex !== null) {
              setFormData(prev => ({ ...prev, items: prev.items.filter((_, i) => i !== deleteModalIndex) }));
              setDeleteModalIndex(null);
            }
          };

          const handleDeleteCancel = () => {
            setDeleteModalIndex(null);
          };

          const calculateTotal = () => {
            return formData.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
          };

          const calculateVAT = () => {
            const total = calculateTotal();
            // –ï—Å–ª–∏ –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –ù–î–°, —Ç–æ –ù–î–° = –ò—Ç–æ–≥–æ * 20 / 120 = –ò—Ç–æ–≥–æ / 6
            return total / 6;
          };

          const handleSave = async () => {
            setSaveStatus('saving');
            
            try {
              // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              const saveData = { ...formData };
              // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –∏–º—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
              if (loadedFilename) {
                saveData._filename = loadedFilename;
              }
              
              const response = await fetch('api/save.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saveData)
              });

              const result = await response.json();

              if (result.success) {
                setSaveStatus('saved');
                // –ï—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ –∂–µ –∏–º—è, –∏–Ω–∞—á–µ –Ω–æ–≤–æ–µ
                setLoadedFilename(result.filename);
                setTimeout(() => setSaveStatus(''), 3000);
                setViewMode('print');
                // –û—á–∏—â–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                setBackupFormData(null);
                setBackupDeliveryPlaceInput(null);
              } else {
                setSaveStatus('error');
                alert(t.saveError + ': ' + result.error);
                setTimeout(() => setSaveStatus(''), 3000);
              }
            } catch (error) {
              setSaveStatus('error');
              alert(t.saveError + ': ' + error.message);
              setTimeout(() => setSaveStatus(''), 3000);
            }
          };

          const handleCancel = () => {
            if (backupFormData) {
              setFormData(backupFormData);
              setBackupFormData(null);
            }
            if (backupDeliveryPlaceInput !== null) {
              setDeliveryPlaceInput(backupDeliveryPlaceInput);
              setBackupDeliveryPlaceInput(null);
            }
            setViewMode('print');
            setSaveStatus('');
          };

          const handleEdit = () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            setBackupFormData(JSON.parse(JSON.stringify(formData)));
            setBackupDeliveryPlaceInput(deliveryPlaceInput);
            setViewMode('edit');
          };

          const handleDownloadPdf = async (e) => {
            if (e) {
              e.preventDefault();
            }
            if (!loadedFilename) {
              alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç');
              return;
            }
            try {
              const url = `${getApiUrl('generate_pdf.php')}?filename=${encodeURIComponent(loadedFilename)}`;
              const response = await fetch(url);
              
              const contentType = response.headers.get('content-type') || '';
              
              if (contentType.includes('application/json')) {
                const errorData = await response.json();
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + (errorData.error || errorData.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                return;
              }
              
              if (!response.ok) {
                try {
                  const errorData = await response.json();
                  alert('–û—à–∏–±–∫–∞: ' + (errorData.error || errorData.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å PDF'));
                } catch {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ PDF. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: ' + response.status);
                }
                return;
              }
              
              const blob = await response.blob();
              const downloadUrl = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = downloadUrl;
              a.download = loadedFilename.replace('.json', '.pdf');
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(downloadUrl);
            } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ PDF:', err);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ PDF: ' + err.message);
            }
          };

          const handlePrint = () => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é
            const message = language === 'ru' 
              ? '‚ö†Ô∏è –í–ê–ñ–ù–û!\n\n–î–ª—è —á–∏—Å—Ç–æ–≥–æ PDF –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:\n\n1. –í –æ–∫–Ω–µ –ø–µ—á–∞—Ç–∏ –Ω–∞–π–¥–∏—Ç–µ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"\n2. –û–¢–ö–õ–Æ–ß–ò–¢–ï –æ–ø—Ü–∏—é "–í–µ—Ä—Ö–Ω–∏–µ –∏ –Ω–∏–∂–Ω–∏–µ –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã"\n3. –ó–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ PDF\n\n–ë–µ–∑ —ç—Ç–æ–≥–æ –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π –≤–≤–µ—Ä—Ö—É –∏ URL –≤–Ω–∏–∑—É.'
              : '‚ö†Ô∏è IMPORTANT!\n\nFor clean PDF without headers:\n\n1. In print dialog find "More settings"\n2. DISABLE "Headers and footers" option\n3. Then save PDF\n\nWithout this, date/URL will be visible.';
            
            if (confirm(message + '\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–µ—á–∞—Ç—å?\nContinue printing?')) {
              // –í—Ä–µ–º–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º title –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
              const originalTitle = document.title;
              document.title = '';
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –≤—Å–µ—Ö textarea –ø–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é
              setTimeout(() => {
                const textareas = document.querySelectorAll('textarea[readonly]');
                textareas.forEach(textarea => {
                  textarea.style.height = 'auto';
                  textarea.style.height = textarea.scrollHeight + 8 + 'px';
                });
                
                // –ü–µ—á–∞—Ç–∞–µ–º –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã
                setTimeout(() => {
                  window.print();
                  setTimeout(() => {
                    document.title = originalTitle;
                  }, 100);
                }, 50);
              }, 10);
            }
          };

          const handleTemplateSelect = useCallback((field, value) => {
            if (!value) return;
            setFormData(prev => ({ ...prev, [field]: value }));
            setTemplateSelection(prev => ({ ...prev, [field]: '' }));
          }, [setFormData, setTemplateSelection]);

          const handleContactTemplateSelect = useCallback((templateId) => {
            if (!templateId) return;
            const template = contactTemplates.find(item => item.id === templateId);
            if (!template) return;
            setFormData(prev => ({
              ...prev,
              contactPerson: template.person,
              position: template.position
            }));
            setTemplateSelection(prev => ({ ...prev, contact: '' }));
          }, [setFormData, setTemplateSelection]);

          const renderInput = (field, props = {}) => {
            const isReadOnly = viewMode === 'print';
            return (
              <input
                {...props}
                value={formData[field]}
                onChange={(e) => handleChange(e, field)}
                readOnly={isReadOnly}
                className={`w-full px-3 py-2 border rounded-md ${
                  isReadOnly ? 'border-none bg-transparent' : 'border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
                } ${props.className || ''}`}
              />
            );
          };

          const renderTextarea = (field, props = {}) => {
            const isReadOnly = viewMode === 'print';
            const { rows = 2, className = '', ...otherProps } = props;
            const textareaRef = useRef(null);
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç—ã
            const adjustHeight = () => {
              if (textareaRef.current && isReadOnly) {
                textareaRef.current.style.height = 'auto';
                textareaRef.current.style.height = textareaRef.current.scrollHeight + 8 + 'px';
              }
            };
            
            useEffect(() => {
              adjustHeight();
              
              // –í—ã–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
              const timer = setTimeout(adjustHeight, 100);
              
              // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
              window.addEventListener('resize', adjustHeight);
              
              return () => {
                clearTimeout(timer);
                window.removeEventListener('resize', adjustHeight);
              };
            }, [formData[field], isReadOnly]);
            
            return (
              <textarea
                {...otherProps}
                ref={textareaRef}
                value={formData[field]}
                onChange={(e) => handleChange(e, field)}
                readOnly={isReadOnly}
                rows={isReadOnly ? 1 : rows}
                className={`w-full px-3 py-2 border rounded-md ${
                  isReadOnly ? 'border-none bg-transparent' : 'border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
                } ${className}`}
              />
            );
          };

          return (
            <div className="min-h-screen bg-gray-50 p-4 md:p-8">
              <div id="printable-content" className="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                
                {/* Action Buttons */}
                <div className="no-print bg-gray-100 border-b p-4 flex flex-wrap gap-3 justify-between">
                  <div className="flex gap-3">
                    {viewMode === 'edit' ? (
                      <>
                        <Button
                          type={saveStatus === 'saved' ? 'default' : 'primary'}
                          onClick={handleSave}
                          disabled={saveStatus === 'saving'}
                        >
                          {saveStatus === 'saving' ? t.saving : saveStatus === 'saved' ? '‚úì ' + t.saved : t.save}
                        </Button>
                        <Button
                          type="default"
                          onClick={handleCancel}
                          disabled={saveStatus === 'saving'}
                        >
                          ‚ùå –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
                        </Button>
                      </>
                    ) : (
                      <>
                        <Button type="default" onClick={handleEdit} className="flex items-center gap-2">
                          <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fillRule="evenodd" clipRule="evenodd" d="M15.7929 3.79288C17.0119 2.57392 18.9882 2.57392 20.2071 3.79288C21.4261 5.01183 21.4261 6.98813 20.2071 8.20709L13.0988 15.3154C12.7144 15.6999 12.2326 15.9726 11.7051 16.1045L8.24256 16.9701C7.90178 17.0553 7.54129 16.9555 7.29291 16.7071C7.04453 16.4587 6.94468 16.0982 7.02988 15.7574L7.89552 12.2949C8.0274 11.7674 8.30015 11.2856 8.68463 10.9012L15.7929 3.79288ZM18.7929 5.20709C18.355 4.76919 17.645 4.76919 17.2071 5.20709L10.0988 12.3154C9.97068 12.4435 9.87976 12.6041 9.83581 12.7799L9.37439 14.6256L11.2201 14.1642C11.3959 14.1202 11.5565 14.0293 11.6846 13.9012L18.7929 6.79287C19.2308 6.35497 19.2308 5.64499 18.7929 5.20709Z" fill="currentColor"/>
                            <path fillRule="evenodd" clipRule="evenodd" d="M2 7C2 4.23858 4.23858 2 7 2H12C12.5523 2 13 2.44772 13 3C13 3.55228 12.5523 4 12 4H7C5.34315 4 4 5.34315 4 7V17C4 18.6569 5.34315 20 7 20H17C18.6569 20 20 18.6569 20 17V12C20 11.4477 20.4477 11 21 11C21.5523 11 22 11.4477 22 12V17C22 19.7614 19.7614 22 17 22H7C4.23858 22 2 19.7614 2 17V7Z" fill="currentColor"/>
                          </svg>
                          {t.edit}
                        </Button>
                        <button 
                          onClick={handleDownloadPdf}
                          className="px-4 py-2 rounded font-medium transition bg-purple-600 hover:bg-purple-700 text-white flex items-center justify-center"
                          title="–°–∫–∞—á–∞—Ç—å PDF"
                        >
                          <img src="pdf-svgrepo-com.svg" alt="PDF" style={{ filter: 'drop-shadow(0 0 2px rgba(255,255,255,0.9))', width: '50px', height: '50px', maxWidth: '50px', maxHeight: '50px', display: 'block' }} />
                        </button>
                      </>
                    )}
                  </div>
                  <Button type="default" href="index.html" className="flex items-center gap-2">
                    <svg width="20px" height="20px" viewBox="0 0 511.999 511.999" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M210.188,91.3c0-10.221-8.286-18.507-18.507-18.507h-60.633c-10.221,0-18.507,8.286-18.507,18.507 s8.286,18.507,18.507,18.507h60.633C201.902,109.807,210.188,101.521,210.188,91.3z" fill="currentColor"/>
                      <path d="M93.923,298.809L12.359,345.9c-16.493,9.522-16.463,33.364,0,42.869l81.565,47.091 c16.492,9.522,37.125-2.423,37.125-21.434v-94.183C131.049,301.2,110.388,289.302,93.923,298.809z" fill="currentColor"/>
                      <path d="M353.754,72.795h-79.701c-10.518,0-18.987,8.773-18.486,19.401c0.469,9.954,9.044,17.612,19.009,17.612h80.9 c66.292,0,120.149,54.253,119.505,120.689c-0.638,65.792-55.232,118.331-121.028,118.331h-185.89 c-6.814,0-12.338,5.524-12.338,12.339v12.338c0,6.814,5.524,12.338,12.338,12.338h187.414 c86.612,0,157.019-70.713,156.52-157.438C511.5,142.034,440.125,72.795,353.754,72.795z" fill="currentColor"/>
                    </svg>
                    {t.backToRegistry}
                  </Button>
                </div>
                
                

                {/* Header */}
                <div className="bg-white border-b p-6">
                  <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                    {/* Left: Logo */}
                    <div className="flex-shrink-0">
                      {organization && (
                        <img src={organization.logo} alt={organization.shortName} className="h-20 md:h-24 w-auto object-contain" />
                      )}
                    </div>
                    
                    
                    {/* Right: Company Details */}
                    {organization && (
                      <div className="text-xs text-gray-600 text-right">
                        <p className="mb-1"><b>{organization.name}</b></p>
                        {organization.INN_vektor && (
                          <p className="mb-1">–ò–ù–ù: {organization.INN_vektor}</p>
                        )}
                        <p className="mb-2">{organization.address}</p>
                        <p className="mb-1">{organization.phone}</p>
                        <p>{organization.email}</p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Title */}
                <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-6 text-center border-b">
                  <h1 className="text-3xl md:text-4xl font-bold text-blue-900 uppercase">{t.title}</h1>
                  
                </div>

                {/* Document Info */}
                <div className="p-6 border-b">
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="space-y-3">
                      <h3 className="font-semibold text-lg">{t.billTo}:</h3>
                      {renderTextarea('recipient', { className: 'font-semibold', placeholder: t.recipient, rows: 2 })}
                      <div>
                        <label className="text-xs font-medium text-gray-600">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                        <AddressAutocomplete
                          value={formData.recipientAddress}
                          onChange={handleAddressChange}
                          onAddressSelect={handleAddressSelect}
                          results={addressSearchResults}
                          showDropdown={showAddressDropdown}
                          onClose={handleCloseAddressDropdown}
                          disabled={viewMode === 'print'}
                        />
                        {viewMode === 'edit' && (
                          <div className="text-xs text-gray-500 mt-1">
                            üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞) –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
                          </div>
                        )}
                      </div>
                      <div>
                        <label className="text-xs font-medium text-gray-600">{t.inn}</label>
                        <div className="relative">
                          {renderInput('recipientINN', { 
                            placeholder: '–ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)',
                            maxLength: 12,
                            pattern: '[0-9]{10}|[0-9]{12}',
                            inputMode: 'numeric'
                          })}
                          {innLoading && (
                            <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                            </div>
                          )}
                        </div>
                        {viewMode === 'edit' && formData.recipientINN && (
                          <div className={`text-xs mt-1 ${
                            formData.recipientINN.length === 10 || formData.recipientINN.length === 12 
                              ? 'text-green-600' 
                              : 'text-orange-600'
                          }`}>
                            {formData.recipientINN.length === 10 
                              ? '‚úì –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (10 —Ü–∏—Ñ—Ä)' 
                              : formData.recipientINN.length === 12 
                              ? '‚úì –ò–ü (12 —Ü–∏—Ñ—Ä)' 
                              : formData.recipientINN.length > 0
                              ? `–í–≤–µ–¥–∏—Ç–µ ${formData.recipientINN.length < 10 ? '–µ—â—ë ' + (10 - formData.recipientINN.length) + ' —Ü–∏—Ñ—Ä' : '–µ—â—ë ' + (12 - formData.recipientINN.length) + ' —Ü–∏—Ñ—Ä'}`
                              : ''}
                            {innLoading && formData.recipientINN.length >= 10 && (
                              <span className="ml-2 text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="space-y-3">
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-xs font-medium text-gray-600">{t.proposalNumber}</label>
                          {renderInput('number', { 
                            className: 'font-semibold',
                            placeholder: '–ù–æ–º–µ—Ä –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
                          })}
                        </div>
                        <div>
                          <label className=".text-xl font-medium text-gray-600">{t.currency}</label>
                          <select
                            value={formData.currency}
                            onChange={(e) => handleChange(e, 'currency')}
                            disabled={viewMode === 'print'}
                            className={`w-full px-3 py-2 border rounded-md ${viewMode === 'print' ? 'border-none' : 'border-gray-300'}`}
                            style={viewMode === 'print' ? { 
                              appearance: 'none',
                              WebkitAppearance: 'none',
                              MozAppearance: 'none',
                              backgroundImage: 'none'
                            } : {}}
                          >
                            <option value="RUB">RUB</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="CNY">CNY</option>
                          </select>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-xs font-medium text-gray-600">{t.date}</label>
                          {viewMode === 'edit' ? (
                            <>
                              {renderInput('date', { type: 'date' })}
                              <div className="text-x1 text-gray-600 mt-1 print-date">{formatDate(formData.date)}</div>
                            </>
                          ) : (
                            <div className="text-x1 text-gray-600 mt-1">{formatDate(formData.date)}</div>
                          )}
                        </div>
                        <div>
                          <label className="text-xs font-medium text-gray-600">{t.validUntil}</label>
                          {viewMode === 'edit' ? (
                            <>
                              {renderInput('validUntil', { type: 'date', min: formData.date })}
                              <div className="text-x1 text-gray-600 mt-1 print-date">{formatDate(formData.validUntil)}</div>
                              <div className="text-xs text-blue-600 italic mt-1 no-print">‚Üª Auto: +30 days</div>
                            </>
                          ) : (
                            <div className="text-x1 text-gray-600 mt-1">{formatDate(formData.validUntil)}</div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Main Content */}
                <div className="p-6">
                  <p className="mb-6 text-gray-700">{t.introText}</p>

                  {/* Items Table */}
                  <div className="overflow-x-auto mb-6">
                    <table className="w-full border-collapse" style={viewMode === 'edit' ? {minWidth: '800px'} : {}}>
                      <colgroup>
                        <col style={{width: '4%'}} /> {/* # */}
                        <col /> {/* Description - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */}
                        <col style={{width: '13%'}} /> {/* Country of Origin */}
                        <col style={{width: '8%'}} /> {/* Qty */}
                        <col style={{width: '8%'}} /> {/* Unit */}
                        <col style={{width: '12%'}} /> {/* Unit Price */}
                        <col style={{width: '12%'}} /> {/* Amount */}
                        {viewMode === 'edit' && <col style={{width: '8%'}} />} {/* Actions */}
                      </colgroup>
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.number}</th>
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.type}</th>
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.countryOfOrigin}</th>
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.quantity}</th>
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.unit}</th>
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.pricePerUnit}, {formData.currency}</th>
                          <th className="border border-gray-300 px-2 py-2 text-xs">{t.total}, {formData.currency}</th>
                          {viewMode === 'edit' && <th className="border border-gray-300 px-2 py-2 text-xs">{t.actions}</th>}
                        </tr>
                      </thead>
                      <tbody>
                        {formData.items.map((item, idx) => (
                          <tr key={idx}>
                            <td className="border px-2 py-2 text-center">{idx + 1}</td>
                            
                            {/* Description (type) - left aligned */}
                            <td className="border px-2 py-2">
                              {viewMode === 'edit' ? (
                                <input
                                  type="text"
                                  value={item.type}
                                  onChange={(e) => handleItemChange(idx, 'type', e.target.value)}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                />
                              ) : (
                                <span className="text-sm">{item.type}</span>
                              )}
                            </td>
                            
                            {/* Country of Origin - center aligned */}
                            <td className="border px-2 py-2 text-center">
                              {viewMode === 'edit' ? (
                                <input
                                  type="text"
                                  value={item.countryOfOrigin}
                                  onChange={(e) => handleItemChange(idx, 'countryOfOrigin', e.target.value)}
                                  className="w-full px-2 py-1 text-sm border rounded text-center"
                                />
                              ) : (
                                <span className="text-sm">{item.countryOfOrigin}</span>
                              )}
                            </td>
                            
                            {/* Quantity - center aligned */}
                            <td className="border px-2 py-2 text-center table-number-cell">
                              {viewMode === 'edit' ? (
                                <input
                                  type="number"
                                  value={item.quantity}
                                  onChange={(e) => handleItemChange(idx, 'quantity', parseInt(e.target.value) || 1)}
                                  className="w-full px-2 py-1 text-sm border rounded text-center table-number-input compact"
                                />
                              ) : (
                                <span className="text-sm">{item.quantity}</span>
                              )}
                            </td>
                            
                            {/* Unit - center aligned */}
                            <td className="border px-2 py-2 text-center">
                              {viewMode === 'edit' ? (
                                <input
                                  type="text"
                                  value={item.unit}
                                  onChange={(e) => handleItemChange(idx, 'unit', e.target.value)}
                                  className="w-full px-2 py-1 text-sm border rounded text-center"
                                />
                              ) : (
                                <span className="text-sm">{item.unit}</span>
                              )}
                            </td>
                            
                            {/* Unit Price - center aligned */}
                            <td className="border px-2 py-2 text-center table-number-cell">
                              {viewMode === 'edit' ? (
                                <input
                                  type="number"
                                  value={item.price}
                                  onChange={(e) => handleItemChange(idx, 'price', parseFloat(e.target.value) || 0)}
                                  className="w-full px-2 py-1 text-sm border rounded text-center table-number-input"
                                />
                              ) : (
                                <span className="text-sm">{formatNumber(item.price)}</span>
                              )}
                            </td>
                            
                            {/* Amount - center aligned */}
                            <td className="border px-2 py-2 font-medium text-sm text-center">
                              {formatNumber(item.quantity * item.price)}
                            </td>
                            
                            {viewMode === 'edit' && (
                              <td className="border px-2 py-2 text-center">
                                <button
                                  onClick={() => removeItem(idx)}
                                  disabled={formData.items.length <= 1}
                                  className="px-2 py-1 disabled:opacity-50 disabled:cursor-not-allowed hover:opacity-80 transition-opacity"
                                  title="–£–¥–∞–ª–∏—Ç—å"
                                >
                                  <img src="delete.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-5 h-5" />
                                </button>
                              </td>
                            )}
                          </tr>
                        ))}
                      </tbody>
                      <tfoot>
                        <tr className="font-bold bg-blue-50">
                          <td colSpan={viewMode === 'edit' ? 6 : 6} className="border px-3 py-2 text-right">{t.totalLabel} {formData.currency}:</td>
                          <td className="border px-3 py-2 text-center">{formatNumber(calculateTotal())}</td>
                          {viewMode === 'edit' && <td className="border"></td>}
                        </tr>
                        <tr className="bg-gray-50">
                          <td colSpan={viewMode === 'edit' ? 6 : 6} className="border px-3 py-2 text-right">–í —Ç–æ–º —á–∏—Å–ª–µ –ù–î–° - 20%:</td>
                          <td className="border px-3 py-2 text-center">{formatNumber(calculateVAT())}</td>
                          {viewMode === 'edit' && <td className="border"></td>}
                        </tr>
                      </tfoot>
                    </table>
                  </div>

                  {viewMode === 'edit' && (
                    <div className="flex justify-end mb-4">
                      <button onClick={addItem} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        {t.addRow}
                      </button>
                    </div>
                  )}

                  {/* Commercial Terms */}
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold mb-4 pb-2 border-b-2 border-blue-500">{t.commercialTerms}</h3>
                    
                    {/* –ë–∞–∑–∏—Å –ø–æ—Å—Ç–∞–≤–∫–∏ - –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
                    <div className="mb-6">
                      <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-lg border border-blue-200 shadow-sm">
                        <label className="text-sm font-bold mb-3 block text-blue-900">{t.incoterm}</label>
                          {viewMode === 'edit' ? (
                            <>
                              <div className="grid grid-cols-2 gap-3 mb-3">
                                <select
                                  value={formData.incoterm}
                                  onChange={(e) => handleChange(e, 'incoterm')}
                                  className="px-3 py-2 border-2 border-blue-300 rounded-md bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                  title="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏"
                                >
                                  {incoterms2020 && incoterms2020.map ? incoterms2020.map(term => (
                                    <option key={term.code} value={term.code} title={term.descriptionRu}>
                                      {term.code} ‚Äî {term.name}
                                    </option>
                                  )) : null}
                                </select>
                                
                                {/* –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –º–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ */}
                                <div>
                                  <CityAutocomplete
                                    value={deliveryPlaceInput}
                                    onChange={handleDeliveryPlaceChange}
                                    onCitySelect={handleCitySelect}
                                    onBlur={handleDeliveryPlaceBlur}
                                    results={citySearchResults}
                                    showDropdown={showCityDropdown}
                                    onClose={handleCloseCityDropdown}
                                    disabled={isPickupCondition}
                                  />
                                  {isPickupCondition && (
                                    <div className="text-xs text-gray-500 mt-1 italic">
                                      üìç –ê–¥—Ä–µ—Å –Ω–∞—à–µ–≥–æ —Å–∫–ª–∞–¥–∞
                                    </div>
                                  )}
                                  {!isPickupCondition && (
                                    <div className="text-xs text-blue-600 mt-1">
                                      üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –≥–æ—Ä–æ–¥ (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)
                                    </div>
                                  )}
                                </div>
                              </div>
                              
                              {/* –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è */}
                              {(() => {
                                const selectedTerm = incoterms2020?.find(t => t.code === formData.incoterm);
                                if (selectedTerm) {
                                  return (
                                    <div className="mt-3 p-3 bg-white rounded border-l-4 border-blue-500">
                                      <p className="text-sm font-semibold text-blue-800 mb-1">
                                        {selectedTerm.code} ({selectedTerm.nameRu})
                                      </p>
                                      <p className="text-xs text-gray-700 leading-relaxed">
                                        {selectedTerm.descriptionRu}
                                      </p>
                                    </div>
                                  );
                                }
                                return null;
                              })()}
                              
                              <div className="mt-3 p-2 bg-blue-100 rounded">
                                <p className="text-sm text-blue-900">
                                  <strong>{formData.incoterm}</strong> ‚Äî {formData.deliveryPlace}
                                </p>
                              </div>
                            </>
                          ) : (
                            <>
                              <div className="mb-2">
                                <p className="text-sm font-semibold text-blue-900">
                                  <strong>{formData.incoterm}</strong> ‚Äî {formData.deliveryPlace}
                                </p>
                              </div>
                              
                              {/* –û–ø–∏—Å–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */}
                              {(() => {
                                const selectedTerm = incoterms2020?.find(t => t.code === formData.incoterm);
                                if (selectedTerm) {
                                  return (
                                    <div className="mt-2 p-3 bg-white rounded border-l-4 border-blue-500">
                                      <p className="text-xs text-gray-600 italic">
                                        {selectedTerm.nameRu}
                                      </p>
                                    </div>
                                  );
                                }
                                return null;
                              })()}
                            </>
                          )}
                      </div>
                    </div>

                    {/* –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –≤ grid */}
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="space-y-4">
                        <div className="bg-gray-50 p-4 rounded-lg">
                          <label className="text-sm font-semibold mb-2 block">{t.paymentTerms}</label>
                          {viewMode === 'edit' && (
                            <div className="mb-2">
                              <label className="text-xs font-medium text-gray-600 mb-1 block">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞</label>
                              <select
                                value={templateSelection.paymentTerms}
                                onChange={(e) => handleTemplateSelect('paymentTerms', e.target.value)}
                                className="w-full px-3 py-2 border rounded-md border-gray-300 bg-white focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω...</option>
                                {paymentTemplates.map(option => (
                                  <option key={option.value} value={option.value}>{option.label}</option>
                                ))}
                              </select>
                            </div>
                          )}
                          <AutoResizeTextarea 
                            field="paymentTerms" 
                            rows={2} 
                            viewMode={viewMode} 
                            formData={formData} 
                            handleChange={handleChange} 
                          />
                          {viewMode === 'edit' && formData.paymentTerms && (() => {
                            const validation = validatePaymentTerms(formData.paymentTerms);
                            if (validation.total > 0) {
                              return (
                                <div className={`text-xs mt-2 ${
                                  validation.valid 
                                    ? 'text-green-600' 
                                    : 'text-red-600'
                                }`}>
                                  {validation.valid 
                                    ? `‚úì –°—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤: ${validation.total}%` 
                                    : `‚ö† ${validation.message}`}
                                </div>
                              );
                            }
                            return null;
                          })()}
                        </div>

                        <div className="bg-gray-50 p-4 rounded-lg">
                          <label className="text-sm font-semibold mb-2 block">
                            {isPickupCondition ? '–°—Ä–æ–∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏' : '–°—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–∫–∏'}
                          </label>
                          {viewMode === 'edit' && (
                            <div className="mb-2">
                              <label className="text-xs font-medium text-gray-600 mb-1 block">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞</label>
                              <select
                                value={templateSelection.deliveryTime}
                                onChange={(e) => handleTemplateSelect('deliveryTime', e.target.value)}
                                className="w-full px-3 py-2 border rounded-md border-gray-300 bg-white focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω...</option>
                                {deliveryTimeTemplates.map(option => (
                                  <option key={option.value} value={option.value}>{option.label}</option>
                                ))}
                              </select>
                            </div>
                          )}
                          {renderInput('deliveryTime')}
                        </div>
                      </div>

                      <div className="space-y-4">
                        <div className="bg-gray-50 p-4 rounded-lg">
                          <label className="text-sm font-semibold mb-2 block">{t.warranty}</label>
                          {viewMode === 'edit' && (
                            <div className="mb-2">
                              <label className="text-xs font-medium text-gray-600 mb-1 block">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞</label>
                              <select
                                value={templateSelection.warranty}
                                onChange={(e) => handleTemplateSelect('warranty', e.target.value)}
                                className="w-full px-3 py-2 border rounded-md border-gray-300 bg-white focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω...</option>
                                {warrantyTemplates.map(option => (
                                  <option key={option.value} value={option.value}>{option.label}</option>
                                ))}
                              </select>
                            </div>
                          )}
                          <AutoResizeTextarea 
                            field="warranty" 
                            rows={3} 
                            viewMode={viewMode} 
                            formData={formData} 
                            handleChange={handleChange} 
                          />
                        </div>
                      </div>
                    </div>
                  </div>

                    {/* Remarks - –≤ —Å–∞–º–æ–º –Ω–∏–∑—É —Ñ–æ—Ä–º—ã */}
                  <div className="mt-6 pt-6 border-t">
                    <div className="bg-gray-50 p-6 rounded-lg w-full">
                      <label className="text-lg font-semibold mb-3 block">{t.remarks}</label>
                      <AutoResizeTextarea 
                        field="remarks" 
                        rows={4} 
                        viewMode={viewMode} 
                        formData={formData} 
                        handleChange={handleChange} 
                      />
                    </div>
                  </div>

                  <div className="print-avoid-break">
                    {/* Banking Details */}
                    {organization && (
                      <div className="mt-6 pt-6 border-t">
                        <h3 className="text-lg font-bold mb-3">{t.bankingDetails || '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã'}</h3>
                        
                        {/* Bank Selection - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞–Ω–∫–æ–≤ */}
                        {organization.bankAccounts && organization.bankAccounts.length > 1 && viewMode === 'edit' && (
                          <div className="mb-4">
                            <label className="text-sm font-medium text-gray-600 mb-2 block">
                              –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫:
                            </label>
                            <select
                              value={formData.selectedBankId || (organization.bankAccounts[0]?.id || '')}
                              onChange={(e) => setFormData(prev => ({ ...prev, selectedBankId: e.target.value }))}
                              className="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              {organization.bankAccounts.map(bank => (
                                <option key={bank.id} value={bank.id}>{bank.name}</option>
                              ))}
                            </select>
                          </div>
                        )}
                        
                        {/* Bank Details Display */}
                        <div className="bg-gray-50 p-4 rounded-lg">
                          {/* –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */}
                          {viewMode === 'print' && (
                            <>
                              {organization.bankAccounts && formData.selectedBankId && (
                                <div className="mb-3">
                                  <strong className="text-sm text-blue-700">
                                    {organization.bankAccounts.find(b => b.id === formData.selectedBankId)?.name || ''}
                                  </strong>
                                </div>
                              )}
                              {!organization.bankAccounts && organization.bankName && (
                                <div className="mb-3">
                                  <strong className="text-sm text-blue-700">
                                    {organization.bankName}
                                  </strong>
                                </div>
                              )}
                            </>
                          )}
                          
                          <pre className="text-sm whitespace-pre-line text-gray-700 font-mono">
                            {(() => {
                              // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ –±–∞–Ω–∫–æ–≤ –∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–∞–Ω–∫
                              if (organization.bankAccounts && organization.bankAccounts.length > 0) {
                                const selectedBank = organization.bankAccounts.find(
                                  b => b.id === formData.selectedBankId
                                ) || organization.bankAccounts[0];
                                return selectedBank.details[language];
                              }
                              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
                              if (organization.bankName || organization.account) {
                                const parts = [];
                                if (organization.bankName) {
                                  parts.push(`–ë–∞–Ω–∫: ${organization.bankName}`);
                                }
                                if (organization.bankAddress) {
                                  parts.push(`–ê–¥—Ä–µ—Å –±–∞–Ω–∫–∞: ${organization.bankAddress}`);
                                }
                                if (organization.account) {
                                  parts.push(`–°—á–µ—Ç: ${organization.account}`);
                                }
                                if (organization.bik) {
                                  parts.push(`–ë–ò–ö: ${organization.bik}`);
                                }
                                if (organization.correspondentAccount) {
                                  parts.push(`–ö–æ—Ä—Ä. —Å—á–µ—Ç: ${organization.correspondentAccount}`);
                                }
                                if (organization.beneficiary) {
                                  parts.push(`–ë–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä: ${organization.beneficiary}`);
                                }
                                return parts.join('\n');
                              }
                              // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                              return organization.bankingDetails?.[language] || '';
                            })()}
                          </pre>
                        </div>
                      </div>
                    )}
                  
                  
                    {/* Signature */}
                    <div className="mt-8 pt-6 border-t-2">
                      <div className="text-right">
                        {/* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç "Authorized Signature" –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/–ø–µ—á–∞—Ç–∏ */}
                        {viewMode === 'edit' && (
                          <p className="text-sm text-gray-600 mb-4">{t.signature}</p>
                        )}
                        <div className="inline-block text-left relative">
                          {viewMode !== 'print' && (
                            <div className="mb-4">
                              <label className="text-xs font-medium text-gray-600 mb-1 block">–®–∞–±–ª–æ–Ω –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ –ª–∏—Ü–∞</label>
                              <select
                                value={templateSelection.contact}
                                onChange={(e) => handleContactTemplateSelect(e.target.value)}
                                disabled={viewMode === 'print'}
                                className="w-64 px-3 py-2 border rounded-md border-gray-300 focus:ring-2 focus:ring-blue-500"
                                style={viewMode === 'print' ? { 
                                  appearance: 'none',
                                  WebkitAppearance: 'none',
                                  MozAppearance: 'none',
                                  backgroundImage: 'none'
                                } : {}}
                              >
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω...</option>
                                {contactTemplates.map(option => (
                                  <option key={option.id} value={option.id}>
                                    {option.person} ‚Äî {option.position}
                                  </option>
                                ))}
                              </select>
                            </div>
                          )}
                          {/* –ü–µ—á–∞—Ç—å –∏ –ø–æ–¥–ø–∏—Å—å - –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/–ø–µ—á–∞—Ç–∏, –Ω–∞–ª–æ–∂–µ–Ω—ã –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ */}
                          {viewMode !== 'edit' && organization.stamp && organization.signature && (
                            <div className="absolute top-0 left-0">
                              {/* –ü–µ—á–∞—Ç—å (—Å–Ω–∏–∑—É) */}
                              <img 
                                src={organization.stamp} 
                                alt="Company Stamp" 
                                className="h-24 w-auto object-contain opacity-80"
                              />
                              {/* –ü–æ–¥–ø–∏—Å—å (—Å–≤–µ—Ä—Ö—É, –Ω–∞–ª–æ–∂–µ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç—å) */}
                              <img 
                                src={organization.signature} 
                                alt="Authorized Signature" 
                                className="absolute top-10 left-0 h-16 w-auto object-contain"
                              />
                            </div>
                          )}
                          <div className={viewMode !== 'edit' ? 'mt-28' : ''}>
                            {renderInput('contactPerson', { className: 'w-64 mb-2 font-semibold', placeholder: 'Name' })}
                            {renderInput('position', { className: 'w-64 text-sm', placeholder: 'Position' })}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è */}
              {deleteModalIndex !== null && (
                <DeleteConfirmModal
                  isOpen={true}
                  onClose={handleDeleteCancel}
                  onConfirm={handleDeleteConfirm}
                  itemName={formData.items[deleteModalIndex]?.type || `–ü–æ–∑–∏—Ü–∏—è ${deleteModalIndex + 1}`}
                />
              )}
            </div>
          );
        };

        // Render
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

