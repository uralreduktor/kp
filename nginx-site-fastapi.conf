# Конфигурация для kp.uralreduktor.com с FastAPI auth
# Директория: /var/www/kp
# 
# ИЗМЕНЕНИЯ:
# - Убран Basic Auth (auth_basic)
# - /api/auth/* проксируется на FastAPI (порт 8000)
# - Legacy PHP API остаётся для совместимости

# HTTPS сервер
server {
    server_name kp.uralreduktor.com;
    
    root /var/www/kp;
    index index.html index.php index.htm;
    
    # Логирование
    access_log /var/log/nginx/kp.uralreduktor.com.access.log;
    error_log /var/www/kp/backend/logs/nginx-error.log;
    
    # Для Let's Encrypt (исключаем из авторизации)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    
    # Gzip сжатие
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;
    
    # FastAPI Health API
    location /api/health/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
    
    # FastAPI Auth API - проксирование на FastAPI сервис
    location /api/auth/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Для WebSocket (если понадобится)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Отключаем буферизацию для streaming ответов
        proxy_buffering off;
    }
    
    # FastAPI Devices API
    location /api/devices/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    # FastAPI Invoices & Services (Migration)
    location ~ ^/api/(invoices|suggest|pdf)/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
    
    # Legacy PHP API (для обратной совместимости)
    location /api/ {
        try_files $uri $uri/ =404;
        
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_read_timeout 300;
            fastcgi_send_timeout 300;
        }
    }
    
    # Обработка PHP файлов в корне
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }
    
    # Защита от доступа к скрытым файлам
    location ~ /\.(?!well-known).* {
        deny all;
    }
    
    # Кэширование статических файлов
    # Изображения (1 год)
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Шрифты (1 год)
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # CSS и JS (30 дней)
    location ~* \.(css|js)$ {
        expires 30d;
        add_header Cache-Control "public, must-revalidate";
        access_log off;
    }
    
    # HTML файлы - без кэширования
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # Основная директория
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Защита от доступа к .htaccess файлам
    location ~ /\.ht {
        deny all;
    }

    # SSL сертификаты (управляется Certbot)
    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/kp.uralreduktor.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/kp.uralreduktor.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# HTTP сервер - перенаправление на HTTPS (управляется Certbot)
server {
    if ($host = kp.uralreduktor.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name kp.uralreduktor.com;
    return 404; # managed by Certbot
}

