# üìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

**–î–∞—Ç–∞:** 22 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π JSON —Ñ–∞–π–ª –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Ç–µ–∫—É—â–µ–≥–æ

---

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. `pi.html` - —Ñ—É–Ω–∫—Ü–∏—è `handleSave()` ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ `loadedFilename` –≤ –∑–∞–ø—Ä–æ—Å –∫ `api/save.php`
- –ï—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω (–µ—Å—Ç—å `loadedFilename`), –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –∏–º—è –≤ –ø–æ–ª–µ `_filename`

**–ö–æ–¥:**
```javascript
const handleSave = async () => {
  setSaveStatus('saving');
  
  try {
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveData = { ...formData };
    // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –∏–º—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
    if (loadedFilename) {
      saveData._filename = loadedFilename;
    }
    
    const response = await fetch('api/save.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(saveData)
    });
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
  }
};
```

---

### 2. `api/save.php` - –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–ª—è `_filename` –≤ –¥–∞–Ω–Ω—ã—Ö
- –ï—Å–ª–∏ `_filename` —É–∫–∞–∑–∞–Ω –∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ
- –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å timestamp

**–ö–æ–¥:**
```php
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
// –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
$filename = null;
if (!empty($data['_filename']) && is_string($data['_filename'])) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ
    $proposedFilename = basename($data['_filename']);
    if (preg_match('/^[a-zA-Z0-9._-]+\.json$/', $proposedFilename)) {
        $filename = $proposedFilename;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
        $filepath = $archiveDir . '/' . $filename;
        if (!file_exists($filepath)) {
            // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å timestamp
            $filename = null;
        }
    }
}

// –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
if (!$filename) {
    $invoiceNumber = preg_replace('/[^a-zA-Z0-9-_]/', '_', $data['number'] ?? 'invoice');
    $timestamp = date('Y-m-d_H-i-s');
    $filename = "{$invoiceNumber}_{$timestamp}.json";
    $filepath = $archiveDir . '/' . $filename;
} else {
    $filepath = $archiveDir . '/' . $filename;
}

// –£–¥–∞–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
unset($data['_filename']);
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ URL: `pi.html?filename=221125-02_2025-11-22_08-34-05.json`
2. –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, `loadedFilename` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `"221125-02_2025-11-22_08-34-05.json"`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
5. `handleSave()` –ø–µ—Ä–µ–¥–∞–µ—Ç `_filename: "221125-02_2025-11-22_08-34-05.json"` –≤ –∑–∞–ø—Ä–æ—Å–µ
6. `api/save.php` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∏ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** –µ–≥–æ
7. –î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `pi.html` –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `filename`
2. `loadedFilename` –æ—Å—Ç–∞–µ—Ç—Å—è `null`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
4. `handleSave()` –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç `_filename` –≤ –∑–∞–ø—Ä–æ—Å–µ
5. `api/save.php` —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å timestamp
6. –î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `basename()` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è path traversal
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ –ø–æ–ª—è `_filename` –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:**
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ `loadedFilename` –≤ –∑–∞–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞ –≤ `api/save.php`
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 22 –Ω–æ—è–±—Ä—è 2025



