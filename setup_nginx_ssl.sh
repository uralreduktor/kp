#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ nginx –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è kp.uralreduktor.com

set -e

DOMAIN="kp.uralreduktor.com"
SITE_CONFIG="/etc/nginx/sites-available/${DOMAIN}"
SITE_ENABLED="/etc/nginx/sites-enabled/${DOMAIN}"
WEB_ROOT="/var/www/kp"

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx –¥–ª—è ${DOMAIN}"
echo "========================================"
echo ""

# –®–∞–≥ 1: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞
echo "1. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞..."
if [ ! -L "$SITE_ENABLED" ]; then
    sudo ln -sf "$SITE_CONFIG" "$SITE_ENABLED"
    echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω: $SITE_ENABLED -> $SITE_CONFIG"
else
    echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi
echo ""

# –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
if sudo nginx -t; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
    exit 1
fi
echo ""

# –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
echo "3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx..."
if sudo systemctl reload nginx; then
    echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ nginx"
    exit 1
fi
echo ""

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞
echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 80..."
if curl -s -o /dev/null -w "%{http_code}" "http://${DOMAIN}" | grep -q "200\|301\|302"; then
    echo "‚úÖ –î–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 80"
else
    echo "‚ö†Ô∏è  –î–æ–º–µ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ."
fi
echo ""

# –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ certbot..."
echo "   –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
if [ -d "/etc/letsencrypt/live/${DOMAIN}" ]; then
    echo "‚ö†Ô∏è  –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–ª—è ${DOMAIN}"
    echo "   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
    CERTBOT_SKIP=true
fi

if [ "$CERTBOT_SKIP" != "true" ]; then
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º --register-unsafely-without-email –µ—Å–ª–∏ email –Ω–µ —É–∫–∞–∑–∞–Ω
    # –ò–ª–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å email: --email your-email@example.com
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–±–µ–∑ www, —Ç–∞–∫ –∫–∞–∫ DNS –¥–ª—è www –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
    if sudo certbot --nginx -d "${DOMAIN}" --non-interactive --agree-tos --register-unsafely-without-email --redirect; then
        echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é:"
        echo "   sudo certbot --nginx -d ${DOMAIN}"
        echo ""
        echo "   –ò–ª–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º email:"
        echo "   sudo certbot --nginx -d ${DOMAIN} --email your-email@example.com"
        exit 1
    fi
else
    echo "‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
fi
echo ""

# –®–∞–≥ 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "6. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if sudo nginx -t; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
    exit 1
fi
echo ""

# –®–∞–≥ 7: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
echo "7. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx..."
if sudo systemctl reload nginx; then
    echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ nginx"
    exit 1
fi
echo ""

# –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
echo "8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ HTTPS..."
sleep 2
if curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}" | grep -q "200\|301\|302"; then
    echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç!"
else
    echo "‚ö†Ô∏è  HTTPS –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é."
fi
echo ""

echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "   –î–æ–º–µ–Ω: https://${DOMAIN}"
echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${WEB_ROOT}"
echo "   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${SITE_CONFIG}"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
echo "   sudo systemctl status nginx"
echo "   sudo certbot certificates"
echo ""

